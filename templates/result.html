<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Career Action Plan</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="container result-container">
        <header>
            <h1>üó∫Ô∏è Your Personalized Career Action Plan</h1>
            <p>For the role of: <strong>{{ plan.chosen_career }}</strong></p>
        </header>
        <main>
            <div class="result-section resume-preview-section">
                <h2>Your AI-Tailored Resume</h2>
                <div class="resume-actions">
                    <a href="{{ url_for('download_resume', filename=resume_pdf_filename) }}" class="download-btn" download>Download PDF Resume</a>
                </div>
                <iframe src="{{ url_for('preview_resume', filename=resume_pdf_filename) }}" width="100%" height="600px"></iframe>
            </div>

            <div class="result-section">
                <h2>1. Career Overview</h2>
                <p class="section-content">{{ plan.career_overview }}</p>
            </div>
            
            <div class="result-section">
                <h2>2. Job Market Skill Analysis</h2>
                <div class="section-content">
                    <p><strong>Top Technical Skills:</strong> {{ plan.skill_analysis.technical_skills | join(', ') }}</p>
                    <p><strong>Top Soft Skills:</strong> {{ plan.skill_analysis.soft_skills | join(', ') }}</p>
                </div>
            </div>

            <div class="result-section">
                <h2>3. Your Profile Feedback</h2>
                <div class="section-content">
                    <p><strong>Strengths:</strong> {{ plan.profile_feedback.resume_strengths | join(' ') }}</p>
                    <p><strong>Gaps to Fill:</strong> {{ plan.profile_feedback.resume_gaps | join(', ') }}</p>
                    <p><strong>LinkedIn Suggestions:</strong></p>
                    <ul>
                        {% for suggestion in plan.profile_feedback.linkedin_suggestions %}
                            <li>{{ suggestion }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <div class="result-section">
                <h2>4. Your 8-Week Learning Roadmap</h2>
                <div class="markdown-content" id="learning-roadmap-content"></div>
            </div>

            <div class="result-section">
                <h2>5. Your Portfolio Project Plan</h2>
                <div class="markdown-content" id="portfolio-plan-content"></div>
            </div>

            <div class="result-section chat-section">
                <h2>Chat with Your AI Coach</h2>
                <p>Ask follow-up questions to dive deeper into your action plan.</p>
                <div class="chat-container" id="chat-container">
                    <div class="chat-message ai">I've built your comprehensive plan and tailored your resume. What's on your mind?</div>
                </div>
                <div class="chat-input-area">
                    <input type="text" id="chat-input" placeholder="e.g., 'Tell me more about the Week 3 project...'">
                    <button id="chat-send-btn">Send</button>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Pass the plan data from Flask (Jinja2) to JavaScript safely as a JSON object
        const planData = {{ plan.dict() | tojson | safe }};

        // Configure the marked.js library to treat newlines as <br> tags
        marked.setOptions({
            breaks: true
        });

        // Render the markdown content with proper formatting
        document.getElementById('learning-roadmap-content').innerHTML = marked.parse(planData.learning_roadmap || '');
        document.getElementById('portfolio-plan-content').innerHTML = marked.parse(planData.portfolio_plan || '');

        // JavaScript for the interactive chat (no changes needed here)
        const chatContainer = document.getElementById('chat-container');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        let chatHistory = [];

        async function handleChatSubmit() {
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;
            appendMessage(userMessage, 'user');
            chatInput.value = '';
            const typingIndicator = appendMessage('Typing...', 'ai typing');

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: userMessage, history: chatHistory })
                });
                const data = await response.json();
                typingIndicator.remove();
                appendMessage(data.response, 'ai');
                chatHistory.push({ "user": userMessage, "ai": data.response });
            } catch (error) {
                typingIndicator.remove();
                appendMessage('Sorry, an error occurred. Please try again.', 'ai');
            }
        }

        function appendMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            messageDiv.innerHTML = marked.parse(text);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return messageDiv;
        }

        chatSendBtn.addEventListener('click', handleChatSubmit);
        chatInput.addEventListener('keypress', (e) => e.key === 'Enter' && handleChatSubmit());
    </script>
</body>
</html>
